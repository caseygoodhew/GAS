<script>

/**
 * Make a remote call handling failures and exceptions
 * 
 * const options = {
 *   handler: (api) => api.myServerMethod,
 *   success: (result, options) => { },
 *   userError: (payload, options) => { }, // gracefully handle UserError throws
 *   failure: (error, options) => { },
 *   failure: 'This is my error message for a simple alert box',
 *   custom: 'Any custom properties that will also be passed to the success & failure handlers'
 * };
 * 
 * remoteCall(options);
 */
const remoteCall = (options) => {
  
  const {handler, success, userError, failure, spinner} = options;

  let api = google.script.run.withUserObject(options);

  const successInterceptor = (fn) => {
    return (data, options) => {
      
      if (data) {
        if (!isObject(data) || !Object.hasOwn(data, 'value')) {
          throw new Error('Did you remember to wrap your api return value with apiResponse()?')
        }
        
        data = JSON.parse(data.value);
      }
      
      fn(data, options);
    }
  }
  
  const userErrorInterceptor = (fn) => {
    return (error, options) => {
      // "UserError: {"payload":"ooooo noooo!"}"
      const re = /^UserError\: (.*)/
      if (re.test(error.message)) {
        const matches = error.message.match(re);
        const {payload} = JSON.parse(matches[1]);
        userError(payload, options)
      } else {
        fn(error, options);
      }
    }
  }

  const finallyWrapper = (fn) => {
    return (...args) => {
      fn(...args);

      if (spinner) {
        hideSpinner();
      }
    }
  }

  let successFn = () => {};
  if (success) {
    successFn = successInterceptor(success);
  }
  api = api.withSuccessHandler(finallyWrapper(successFn));

  let failureFn = () => {};
  if (failure || userError) {
    
    if (typeof failure === 'string') {
      failureFn = commonFailureHandler;
    } else if (failure) {
      failureFn = failure;
    }

    if (userError) {
      failureFn = userErrorInterceptor(failureFn);
    }
  }
  api = api.withFailureHandler(finallyWrapper(failureFn));

  try {
    if (spinner) {
      showSpinner(spinner === true ? undefined : spinner);
    }
    handler(api);
  } catch (e) {
    
    finallyWrapper(failureFn)(e, options);
    
    if (!failure) {
      throw e;
    }
  }  
};

const commonFailureHandler = (error, options) => {
  showError(options.failure, error);
}

const showError = (title, error) => {
  console.error(`${title}\n${error.message ?? error}\n\nStack trace\n${error.stack}`);
  showAlert(title, error.message ?? error);
}

/**
 * Deeply compares two values for equality.
 * Short-circuits as soon as a mismatch is found.
 */
const isEqual = (a, b) => {
  // 1. Strict equality for primitives and same-reference objects
  if (a === b) return true;

  // 2. Handle null/undefined or type mismatches
  if (a == null || b == null || typeof a !== typeof b) return false;

  // 3. Handle Arrays
  if (Array.isArray(a) && Array.isArray(b)) {
    if (a.length !== b.length) return false;
    // .every() short-circuits on the first 'false' return
    return a.every((val, index) => isEqual(val, b[index]));
  }

  // 4. Handle Objects
  if (typeof a === 'object') {
    const keysA = Object.keys(a);
    const keysB = Object.keys(b);

    if (keysA.length !== keysB.length) return false;

    // Check every key recursively
    return keysA.every(key => 
      Object.prototype.hasOwnProperty.call(b, key) && isEqual(a[key], b[key])
    );
  }

  // 5. Fallback for primitives that failed the strict check (like NaN)
  return false;
};

console.logJSON = obj => {
  console.log(JSON.stringify(obj, undefined, 2));
}

/**
 * Displays a custom alert box
 * @param {string} title - The header text
 * @param {string} message - The body text
 */
const showAlert = (title, message) => {
  const modal = document.getElementById('customAlert');
  
  if (!modal) {
    // if the modal hasn't been added, fall back to the standard alert box
    console.warn('Alert modal not found. You need to include html/alert as the last element of the body');
    alert(`${title}\n\n${message}`);
    return;
  }
  
  document.getElementById('alertTitle').innerText = title;
  document.getElementById('alertMessage').innerText = message;
  modal.classList.remove('hidden');
};

/**
 * Closes the custom alert box
 */
const closeAlert = () => {
  document.getElementById('customAlert').classList.add('hidden');
};

/**
 * Shows the classic spinner
 * @param {string} msg - The text to display under the spinner
 */
const showSpinner = (msg = 'Loading...') => {
  document.getElementById('loaderText').innerText = msg;
  document.getElementById('spinnerModal').classList.remove('hidden');
};

/**
 * Hides the spinner
 */
const hideSpinner = () => {
  document.getElementById('spinnerModal').classList.add('hidden');
};

const formatToYYYYMMDD = (date) => {
  if (typeof date === 'string') {
    // try to convert it to a date - a valid usecase would be TZ included
    date = new Date(date);
  }
  
  const format = new Intl.DateTimeFormat('en-CA', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  });
  
  // Note: en-CA (Canada) conveniently defaults to YYYY-MM-DD
  return format.format(date);
};

/**
 * Debounce utility to prevent multiple rapid executions
 * @param {Function} callback - The function to execute
 * @param {number} delay - Delay in milliseconds
 * @returns {Function}
 */
const debounce = (callback, delay = 1) => {
  let timeoutId;
  
  return (...args) => {
    // Clear the previous timer to reset the countdown
    clearTimeout(timeoutId);
    
    // Set a new timer
    timeoutId = setTimeout(() => {
      callback(...args);
    }, delay);
  };
};

const toTitleCase = (str) => {
  if (!str) {
    return "";
  }

  // Handle CONSTANT_CASE by converting to lowercase if the whole string is uppercase
  // This prevents Step 1 from adding spaces between every letter of an acronym or constant
  const normalizedStr = str === str.toUpperCase() ? str.toLowerCase() : str;

  return normalizedStr
    // Step 1: Add spaces before capital letters (for camelCase/PascalCase)
    // Only adds space if there is a character before the capital letter
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    // Step 2: Replace underscores and hyphens with spaces
    .replace(/[_-]+/g, " ")
    // Step 3: Trim leading/trailing spaces and split into words
    .trim()
    .split(/\s+/)
    .map((word) => {
      // Step 4: Capitalise the first letter of every word
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    })
    .join(" ");
};

const isObject = (o) => {
  return Object.prototype.toString.call( o ) === '[object Object]';
}

const clone = (o) => {
  return JSON.parse(JSON.stringify({ o })).o;
}

</script>
