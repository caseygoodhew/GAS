<script>
const predictorModuleController = (() => {

  const USE_SAMPLE_DATA = true;

  const emptyModule = {
    init: () => {},
    activate: () => {},
    getData: () => ({})
  }

  const constants = ['SETUP', 'CREATE', 'COMPARE', 'DEBUG'].reduce((acc, val) => ({ ...acc, [val]: val }), {});
  
  const {
    SETUP,
    CREATE,
    COMPARE,
    DEBUG
  } = constants;

  const INITIAL_TAB = SETUP;
  
  const moduleMap = {
    [SETUP]: predictorSetupTab,
    [CREATE]: predictorCreateTab,
    [COMPARE]: emptyModule,
    [DEBUG]: predictorDebugTab
  }
  
  const bus = {
    relay: (target) => {
      return moduleMap[target];
    }
  }

  const initModules = (initData) => {
    Object.keys(constants).forEach(moduleKey => {
      moduleMap[moduleKey].init({
        moduleKey,
        bus,
        constants,
        data: initData[moduleKey]
      })
    });
  }

  /**
   * Tab Switching Logic
   */
  const openTab = (tabKey) => {
    const contents = document.querySelectorAll(".tab-content");
    contents.forEach(content => content.classList.remove("active"));
    
    const links = document.querySelectorAll(".tab-link");
    links.forEach(link => link.classList.remove("active"));
    
    document.getElementById(`tab-link-${tabKey.toLowerCase()}`).classList.add("active");
    document.getElementById(`tab-${tabKey.toLowerCase()}`).classList.add("active");

    bus.relay(tabKey).activate();
  };

  const init = () => {
      /**
     * Initial Load
     */
    if (USE_SAMPLE_DATA) {
      initModules(getSampleData());
    } else {
      remoteCall({
        handler: (api) => api.getInitialData(),
        spinner: 'Loading configuration...',
        success: initModules,
        failure: 'Failed to load initial data'
      });
    }

    openTab(INITIAL_TAB);
  }

  return {
    init,
    openTab
  }
})();

document.addEventListener('DOMContentLoaded', predictorModuleController.init);

</script>