<script>
const USE_SAMPLE_DATA = true;

/**
 * Initial Load using your remoteCall utility
 */
document.addEventListener('DOMContentLoaded', () => {
  if (USE_SAMPLE_DATA) {
    initializeSetup(getSampleData());
  } else {
    remoteCall({
      handler: (api) => api.getInitialData(),
      spinner: 'Loading configuration...',
      success: initializeSetup,
      failure: 'Failed to load initial setup data'
    });
  }
});

const initializeSetup = (data) => {
  // Use your common.gs utility to format the date correctly for the input
  document.getElementById('opening-date').value = formatToYYYYMMDD(data.openingDate || new Date());
  
  // Store data globally for Task 2/3
  window.appState = data;
  
  renderOwners();
  renderAccounts();
};

/**
 * Renders the list of account owners into the #owners-list div
 */
const renderOwners = () => {
  const container = document.getElementById('owners-list');
  const owners = window.appState.owners;

  if (owners.length === 0) {
    container.innerHTML = '<p style="font-style: italic; color: #999;">No owners added yet.</p>';
    return;
  }

  container.innerHTML = owners.map((owner, index) => `
    <div class="list-item">
      <span>${owner}</span>
      <button class="btn-icon" onclick="removeOwner(${index})">üóëÔ∏è</button>
    </div>
  `).join('');
};

/**
 * Adds a new owner from the HTML input field
 */
const addOwner = () => {
  const input = document.getElementById('new-owner-name');
  const name = input.value.trim();
  
  if (!name) return;

  // Prevent duplicates
  if (window.appState.owners.includes(name)) {
    showAlert("Duplicate Name", `${name} is already in the list.`);
    return;
  }

  // Update state and UI
  window.appState.owners.push(name);
  input.value = ''; // Clear input
  input.focus();    // Keep focus for rapid entry
  
  renderOwners();
  renderAccounts();
};

/**
 * Allows adding owners by pressing 'Enter'
 */
const handleOwnerKeyPress = (e) => {
  if (e.key === 'Enter') {
    addOwner();
  }
};

/**
 * Removes an owner if they are not linked to any accounts
 */
const removeOwner = (index) => {
  const ownerToRemove = window.appState.owners[index];
  
  // Validation: Check if the owner is assigned to any accounts
  const isAssigned = window.appState.accounts.some(acc => acc.owner === ownerToRemove);

  if (isAssigned) {
    showAlert("Cannot Remove", `${ownerToRemove} is currently assigned to an account and cannot be removed.`);
    return;
  }

  window.appState.owners.splice(index, 1);
  renderOwners();
  renderAccounts();
};

const renderAccounts = () => {
  var container = document.getElementById('accounts-list');
  var template = document.getElementById('account-row-template');
  var accounts = window.appState.accounts || [];
  var owners = window.appState.owners || [];

  container.innerHTML = '';

  if (accounts.length === 0) {
    container.innerHTML = '<p class="empty-msg">No accounts added. Click "+ Add Account" to begin.</p>';
    return;
  }

  accounts.forEach(function(acc, index) {
    var clone = template.content.cloneNode(true);
    var row = clone.querySelector('.account-row');

    // Populate Owner Dropdown
    var ownerSelect = row.querySelector('.field-owner');
    owners.forEach(function(owner) {
      var opt = document.createElement('option');
      opt.value = owner;
      opt.textContent = owner;
      if (acc.owner === owner) opt.selected = true;
      ownerSelect.appendChild(opt);
    });

    // Set Values
    row.querySelector('.field-name').value = acc.name || '';
    row.querySelector('.field-currency').value = acc.currency || 'GBP';
    row.querySelector('.field-balance').value = acc.balance ?? 0;
    row.querySelector('.field-aer').value = acc.aer ?? 0;

    // Listeners
    row.querySelector('.field-name').oninput = function(e) { updateAccountField(index, 'name', e.target.value); };
    ownerSelect.onchange = function(e) { updateAccountField(index, 'owner', e.target.value); };
    row.querySelector('.field-currency').onchange = function(e) { updateAccountField(index, 'currency', e.target.value); };
    row.querySelector('.field-balance').oninput = function(e) { updateAccountField(index, 'balance', e.target.value); };
    row.querySelector('.field-aer').oninput = function(e) { updateAccountField(index, 'aer', e.target.value); };
    row.querySelector('.field-delete').onclick = function() { removeAccount(index); };

    container.appendChild(clone);
  });
}

/**
 * Adds a new account with default values to the state
 */
const addAccount = () => {
  const newAccount = {
    name: '',
    owner: window.appState.owners[0] || '',
    currency: 'GBP',
    balance: 0,
    aer: 0
  };
  
  if (!window.appState.accounts) window.appState.accounts = [];
  window.appState.accounts.push(newAccount);
  renderAccounts();
};

/**
 * Removes an account from the state
 */
const removeAccount = (index) => {
  window.appState.accounts.splice(index, 1);
  renderAccounts();
};

/**
 * Syncs UI input changes back to the global state
 */
const updateAccountField = (index, field, value) => {
  const val = (field === 'balance' || field === 'aer') ? parseFloat(value) || 0 : value;
  window.appState.accounts[index][field] = val;
};

/**
 * Updates the opening date in the global state
 */
const updateOpeningDate = (value) => {
  window.appState.openingDate = value;
};

/**
 * Tab Switching Logic (already in your file)
 */
const openTab = (evt, tabId) => {
  const contents = document.querySelectorAll(".tab-content");
  contents.forEach(content => content.classList.remove("active"));
  
  const links = document.querySelectorAll(".tab-link");
  links.forEach(link => link.classList.remove("active"));
  
  document.getElementById(tabId).classList.add("active");
  evt.currentTarget.classList.add("active");

  if (tabId === 'tab-debug') {
    refreshDebugView();
  }
};

/**
 * Pretty-prints the appState into the debug <pre> tag
 */
const refreshDebugView = () => {
  const debugContainer = document.getElementById('debug-state');
  if (debugContainer) {
    debugContainer.textContent = JSON.stringify(window.appState, null, 2);
  }
};

/**
 * Gathers the current state and sends it to the server
 */
const handleSave = () => {
  remoteCall({
    handler: (api) => api.saveSetupData(window.appState),
    spinner: 'Saving your settings...',
    success: (result) => {
      const status = document.getElementById('save-status');
      status.textContent = 'Last saved at ' + new Date().toLocaleTimeString('en-GB');
      status.style.color = '#1e8e3e';
      
      // Optional: Visual confirmation via your alert.html
      // showAlert('Success', 'Configuration saved successfully.');
    },
    failure: 'There was a problem saving your data. Please try again.'
  });
};

/**
 * Copies the current appState JSON to the clipboard with SVG feedback
 */
const copyDebugToClipboard = (event) => {
  const json = JSON.stringify(window.appState, null, 2);
  const btn = event.currentTarget;
  const originalIcon = btn.innerHTML;
  
  const checkIcon = `
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>`;

  navigator.clipboard.writeText(json).then(() => {
    btn.innerHTML = checkIcon;
    btn.classList.add('copy-success');

    setTimeout(() => {
      btn.innerHTML = originalIcon;
      btn.classList.remove('copy-success');
    }, 1500);
  }).catch(err => {
    console.error('Clipboard error:', err);
    showAlert('Error', 'Failed to copy to clipboard.');
  });
};
</script>